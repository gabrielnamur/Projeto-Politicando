<!DOCTYPE html>
<html>

<head>
  <title>Lista de Deputados Federais</title>

  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background-color: #f2f2f2;
      font-family: Arial, sans-serif;
    }

    h1 {
      text-align: center;
      font-size: 36px;
      margin-top: 50px;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <div class="imgBox">
        <a href="./index.html">
          <img src="./logo_img.png" alt="">
        </a>
      </div>
      <div class="menuBox">
        <ul class="menuList">
          <li class="menuTopics"><a href="telalogada.html">In√≠cio</a></li>
          <li class="menuTopics"><a href="telalogada.html">Valores</a></li>
          <li class="menuTopics"><a href="telalogada.html">M√©tricas</a></li>
          <li class="menuTopics"><a href="FAQ.html">FAQ</a></li>
          <li class="menuTopics"><a href="newsletterdeputados.html">News</a></li>
          <li class="menuTopics"><a href="avaliardeputados.html">Avalie!</a></li>
          <li class="menuTopics"><a href="questionario_politico.html">Question√°rio</a></li>
          <li class="menuTopics"><a href="telalogada.html">Contatos</a></li>
          <li class="menuTopics"><a href="index.html">Sair</a></li>
          <div>Seja Bem-vindo, <span id="span_nome_usuario"></span>!</div>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <div class="listadeputados">
    <h1>Avaliar Deputados | Politicando¬Æ üîé</h1>
    <h3>Pesquise o Deputado da atual legislatura abaixo e avalie-no agora!</h3><br>
    <input id="ipt_nome_deputado" type="text" placeholder="Insira o nome do Deputado Federal">
    <button onclick="ver_deputado()">Veja o Status!</button>
    <button onclick="atualizarGraficolike()">üëç</button>
    <button onclick="atualizarGraficodislike()">üëé</button>
    <div class="dep_container">
      <table>
        <tbody id="deputados">

        </tbody>
      </table>
      <div id="graficosLikeDislike">
        <canvas id="chartlike"></canvas>
        <canvas id="chartdislike"></canvas>
      </div>
    </div>
  </div>

</body>

</html>
<script>
  var spanNomeUsuario = document.getElementById("span_nome_usuario")
  spanNomeUsuario.innerHTML = sessionStorage.getItem("NOME_USUARIO");
  console.log(spanNomeUsuario);
</script>
<script>
  var nomeDeputado = "";
  function ver_deputado() {
    var tBody = document.getElementById("deputados");
    var var_nome_deputado = ipt_nome_deputado.value.toLowerCase();
    fetch('https://dadosabertos.camara.leg.br/api/v2/deputados/')
      .then(response => response.json())
      .then(data => {
        const deputados = data.dados;

        var deputadosFiltrados = deputados.filter(deputado => deputado.nome.toLowerCase().includes(var_nome_deputado))

        console.log(deputadosFiltrados)

        deputadosFiltrados.forEach(deputado => {


          var texto = `<tr>
                <td>${deputado.nome} |</td> 
                  <td>${deputado.siglaPartido} |</td>
                  <td>${deputado.siglaUf} |</td>
                  <td>${deputado.email} </td>
                  <img src="${deputado.urlFoto}" class="foto-deputado" width="120px">
                </tr>`

          console.log(deputado);
          nomeDeputado = deputado.nome;
          tBody.innerHTML += texto;
        });
      })
      .catch(error => {
        console.error(error);
      });
  }

  var votosPositivos = 0;
  var votosNegativos = 0;

  function votarPositivo() {
    var votosPositivos = 1
    atualizarGraficolike();
  }

  function votarNegativo() {
    var votosNegativos = 1
    atualizarGraficodislike();
  }

  function atualizarGraficolike() {

    var fkUsuario = sessionStorage.getItem("ID_USUARIO");

    if (nomeDeputado == "") {
      alert("Pesquise um deputado")
    } else {
      fetch("/avaliardeputados/deputados_avaliados_positivamente", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          votosPositivosServer: nomeDeputado,
          idUsuarioServer: fkUsuario
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);
        if (resposta.ok) {
          alert('Cadastro realizado com sucesso')
          // Grafico
          var ctxlike = document.getElementById('chartlike');
          var chartlike = new Chart(ctxlike, {
            type: 'pie',
            data: {
              labels: ['Likes'],
              datasets: [{
                data: [votosPositivo],
                backgroundColor: ['#36A2EB', '#FF6384'],
                hoverBackgroundColor: ['#36A2EB', '#FF6384']
              }]
            }
          });
          chartlike.canvas.parentNode.style.height = '50vh';
          chartlike.canvas.parentNode.style.width = '50vw';
        } else {
          alert("Houve um erro ao tentar realizar o cadastro!");
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });
    }


    return false;

  }

  function atualizarGraficodislike() {

    var fkUsuario = sessionStorage.getItem("ID_USUARIO");
    if (nomeDeputado == "") {
      alert("Pesquise um deputado")
    } else {
      // Arrumar fetch para linkar o grafico
      fetch("/avaliardeputados/deputados_avaliados_negativamente", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          votosNegativosServer: nomeDeputado,
          idUsuarioServer: fkUsuario
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);
        if (resposta.ok) {
          alert('Cadastro realizado com sucesso')
         var ctxdislike = document.getElementById('chartdislike');
          var chartdislike = new Chart(ctxdislike, {
            type: 'pie',
            data: {
              labels: ['Dislikes'],
              datasets: [{
                data: [votosNegativos],
                backgroundColor: ['#36A2EB', '#FF6384'],
                hoverBackgroundColor: ['#36A2EB', '#FF6384']
              }]
            }
          });
          chartdislike.resize('300', '300')
        } else {
          alert("Houve um erro ao tentar realizar o cadastro!");
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });
    }

    return false;
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>